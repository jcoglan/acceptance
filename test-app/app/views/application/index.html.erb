<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Page Title</title>
    <%= javascript_include_tag 'acceptance' %>
  </head>
  <body>
  
    <% validated_form_for(@article) do |f| %>
      <%= field f, :title %>
      <%= field f, :password %>
      <%= field f, :password_confirmation %>
      <%= submit_tag "Save" %>
    <% end %>
    
    <script type="text/javascript">
    Acceptance.onValidation(function(field) {
      var input     = field.getInput(),
          container = input.parentNode,
          errorElem = container.getElementsByTagName('span')[0];
      
      if (field.isIndeterminate() || field.isValid()) {
        if (errorElem) errorElem.parentNode.removeChild(errorElem);
      } else {
        if (!errorElem) {
          errorElem = document.createElement('span');
          container.appendChild(errorElem);
        }
        errorElem.innerHTML = field.getErrorMessages()[0];
      }
    });
    
    Acceptance.macro('toValidateSlowly', function(message) {
      return function(returns, validation) {
        var value  = validation.getValue(),
            input  = validation.getInput();
        
        if (!validation.isValid() ||
            validation.getEventType() === 'submit')
          return returns(true);
        
        input.value = 'Validating...';
        
        var cancel = function() {
          input.value = value;
          cancel = function() {};
        };
        
        validation.onCancel(cancel);
        
        setTimeout(function() {
          cancel();
          returns( (value === 'script') ? true : [message] );
        }, 5000);
      };
    });
    
    Acceptance.form('new_article').
    requires('article[title]').toValidateSlowly('Too slow!');
    </script>
  
  </body>
</html>

